digraph RetroGamesWorkflow {
    rankdir=LR;
    node [shape=box, style="rounded,filled", fontname="Arial", color=black, fillcolor=white];
    edge [fontname="Arial"];

    Start [shape=circle, label="Start", fillcolor=lightgreen];
    
    subgraph cluster_inputs {
        label = "User Inputs";
        style = filled;
        color = lightgrey;
        InputImage [label="Input Image\n(Upload/Library/Selfie)", shape=note, fillcolor=lightyellow];
        ThemeSelection [label="Theme Selection\n(Dish/Sling/Boost)", shape=parallelogram, fillcolor=lightcyan];
        Configuration [label="Configuration\n(Context, Model, Duration, Bumper)", shape=parallelogram, fillcolor=lightcyan];
    }
    
    Generate8Bit [label="Step 1: Generate 8-bit Image\n(Gemini 2.5 Flash Image)", fillcolor=lightblue];
    GenerateCharSheet [label="Step 2: Generate Character Sheet\n(Gemini 2.5 Flash Image)", fillcolor=lightblue];
    GenerateSceneDirection [label="Step 3a: Generate Scene Direction\n(Gemini 2.5 Flash)", fillcolor=lightyellow];
    GenerateVideo [label="Step 3b: Generate Video\n(Veo 3.1 R2V)", fillcolor=lightpink];
    AppendBumper [label="Step 4: Append Bumper\n(FFmpeg/MoviePy)", fillcolor=lightgrey, style="dashed,filled"];
    
    Regenerate [label="Regenerate Video\n(Skip Steps 1 & 2)", shape=diamond, fillcolor=orange];

    FinalVideo [label="Final Retro Game Video", shape=component, fillcolor=gold];
    End [shape=doublecircle, label="End", fillcolor=lightgreen];

    Start -> InputImage;
    Start -> ThemeSelection;
    Start -> Configuration;

    InputImage -> Generate8Bit [label="Input"];
    ThemeSelection -> Generate8Bit [label="Theme Prompt"];
    
    Generate8Bit -> GenerateCharSheet [label="8-bit Image"];
    Generate8Bit -> GenerateSceneDirection [label="8-bit Image"];
    Generate8Bit -> GenerateVideo [label="R2V Ref 1 (8-bit Image)"];
    
    GenerateCharSheet -> GenerateVideo [label="R2V Ref 2 (Char Sheet)"];
    
    Configuration -> GenerateSceneDirection [label="Context"];
    Configuration -> GenerateVideo [label="Model/Duration"];
    ThemeSelection -> GenerateVideo [label="Theme Logo (8-bit)"];
    
    GenerateSceneDirection -> GenerateVideo [label="Prompt"];
    
    GenerateVideo -> AppendBumper [label="Raw Video"];
    Configuration -> AppendBumper [label="Toggle"];
    
    AppendBumper -> FinalVideo;
    GenerateVideo -> FinalVideo [label="If Bumper Disabled", style=dashed];
    
    FinalVideo -> End;

    # Regeneration Path
    FinalVideo -> Regenerate [label="User Action"];
    Regenerate -> GenerateSceneDirection [label="Reuse Assets"];

    subgraph cluster_gemini {
        label = "Gemini Models";
        style = dashed;
        color = blue;
        Generate8Bit;
        GenerateCharSheet;
        GenerateSceneDirection;
    }

    subgraph cluster_veo {
        label = "Veo Models";
        style = dashed;
        color = red;
        GenerateVideo;
    }
}