# Motion Portraits Page Refactor and Enhancement Plan

## Overview

This document outlines a phased approach to refactor the Motion Portraits page. The primary goals are to make the style modifier system more robust and extensible, add dynamic Veo model selection, and prepare the architecture for a more advanced, grid-based UI with video previews, as inspired by a more modern layout.

---

## Phase 1: Refactor and Externalize Style Modifiers

**Goal:** Decouple the style definitions from the UI logic and create a more descriptive prompt generation system.

**Technical Steps:**

1.  **Create `config/portrait_styles.py`:**
    *   Create a new file: `config/portrait_styles.py`.
    *   Define a Pydantic model or dataclass named `PortraitStyle` at the top of the file:
        ```python
        from pydantic import BaseModel

        class PortraitStyle(BaseModel):
            id: str
            label: str
            description: str
            representative_video_gcs_uri: str
        ```
    *   Create a list named `PORTRAIT_STYLES` of `PortraitStyle` instances. Populate this list with the existing styles and the newly generated ones ("selling", "podcast", etc.). Use a placeholder URI for `representative_video_gcs_uri` for now (e.g., `"gs://genai-blackbelt-fishfooding-assets/portraits/placeholder.mp4"`).

2.  **Update `pages/portraits.py` - Data Source:**
    *   In `pages/portraits.py`, remove the hardcoded `modifier_options` list.
    *   Add the import: `from config.portrait_styles import PORTRAIT_STYLES`.
    *   In the UI rendering section, find the loop that creates the style buttons and change it to iterate over `PORTRAIT_STYLES`.
    *   The button's `key` should be set to `f"mod_btn_{style.id}"` and the displayed text should be `style.label`.

3.  **Update `pages/portraits.py` - Prompt Logic:**
    *   In the `on_click_motion_portraits` function, locate the prompt construction logic.
    *   Replace the existing logic that joins the modifier keys.
    *   The new logic will first create a list of the full `PortraitStyle` objects that correspond to the selected IDs stored in `state.modifier_array`.
    *   It will then loop through this list of objects and append each style's `description` to the `final_prompt_for_llm` string, creating a more detailed and descriptive prompt for the Gemini scene generator.

---

--

## Phase 2: Veo Model Selection and Dynamic Options

**Goal:** Empower users to select different Veo models and have the UI dynamically adapt to each model's specific capabilities.

**Technical Steps:**

1.  **Enhance `config/veo_models.py`:**
    *   Inspect the existing `config/veo_models.py`.
    *   Define a `VeoModelConfig` Pydantic model (if one doesn't exist) to standardize the model definitions. It must include:
        ```python
        class VeoModelConfig(BaseModel):
            id: str
            label: str
            max_duration_seconds: int
            supported_aspect_ratios: list[str]
            supports_enhance_prompt: bool
        ```
    *   Refactor the existing `VEO_MODELS` dictionary or list to use this new model, populating the capability fields for each Veo model (e.g., Veo 2, Veo 3, Veo 3 Fast).

2.  **Update `pages/portraits.py` - Add Model Selector UI:**
    *   In the "Video options" section of the UI, add a `me.select` component for Veo model selection.
    *   The `options` for this select should be generated by iterating through the `VEO_MODELS` config, using `model.label` for the display text and the dictionary key (e.g., `"2.0"`) for the `value`.
    *   The selected value will be stored in the existing `state.veo_model`.

3.  **Update `pages/portraits.py` - Implement Dynamic UI:**
    *   Create a new event handler function, `on_model_selection_change(e: me.SelectSelectionChangeEvent)`.
    *   Wire this handler to the `on_selection_change` event of the new model selector.
    *   Inside this handler:
        *   Get the config for the selected model from `VEO_MODELS`.
        *   **Update Length Options:** Generate a new list of `me.SelectOption` for the video length dropdown, from 5 seconds up to the model's `max_duration_seconds`.
        *   **Update Aspect Ratio Options:** Generate a new list of `me.SelectOption` for the aspect ratio dropdown from the model's `supported_aspect_ratios` list.
        *   **Update Auto-Enhance:** Set the `disabled` property of the `me.checkbox` for "auto-enhance prompt" to `not model.supports_enhance_prompt`.
        *   **Validation:** Check if `state.video_length` and `state.aspect_ratio` are still valid for the new model. If not, reset them to the first available valid option.
        *   `yield` at the end of the handler to apply the UI updates.

4.  **Update `pages/portraits.py` - Video Generation Request:**
    *   In `on_click_motion_portraits`, find where `VideoGenerationRequest` is created.
    *   Ensure the `model_version_id` parameter is populated with the full model ID from the config: `VEO_MODELS[state.veo_model].id`.

4.  **Implement Selection Limit in `pages/portraits.py`:**
    *   Modify the `on_modifier_click` event handler.
    *   When a user clicks to select a *new* modifier, check the length of `state.modifier_array`.
    *   If `len(state.modifier_array) >= 2`, prevent the selection and exit the function early. The logic for deselecting a style will not be affected.
---


## Phase 3: Grid-Based UI with Video Previews (Future Vision)

**Goal:** Evolve the UI to match the more immersive and visual layout seen in `higgs.png`.

**Technical Vision:**

*   The linear row of style modifier buttons will be replaced with a responsive grid.
*   Each item in the grid will be a `me.box` styled to be a clickable card.
*   Inside each card, a `me.video` component will display the `representative_video_gcs_uri` for that style, set to loop and be muted.
*   A text label (`style.label`) will be overlaid on top of the video. This will likely require careful styling with `position="absolute"` and z-indexing.
*   The `on_click` handler for the card will manage the selection state, and a visual indicator (like a colored border or checkmark) will show the selected styles.
